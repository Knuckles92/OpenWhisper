name: Track Clone Statistics

on:
  schedule:
    # Run daily at midnight UTC (adjust timezone as needed)
    - cron: '0 0 * * *'
  workflow_dispatch:  # Allow manual runs from Actions tab
  push:
    branches:
      - main
    paths:
      - '.github/workflows/track-clones.yml'
      - 'scripts/track_clone_stats.py'

jobs:
  collect-stats:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to commit and push
      actions: read    # Required to read workflow status
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Fetch clone statistics
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        REPO_OWNER: Knuckles92
        REPO_NAME: OpenWhisper
      run: |
        echo "Fetching clone statistics..."
        curl -H "Authorization: token $GITHUB_TOKEN" \
          -H "Accept: application/vnd.github.v3+json" \
          https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/traffic/clones \
          > clone_data_temp.json || echo '{"count":0,"uniques":0,"clones":[]}' > clone_data_temp.json
        
        # Display the fetched data
        cat clone_data_temp.json
    
    - name: Process and save statistics
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        REPO_OWNER: Knuckles92
        REPO_NAME: OpenWhisper
      run: |
        python scripts/track_clone_stats.py
    
    - name: Commit and push statistics
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # Check if there are changes to commit
        if git diff --quiet --exit-code clone_statistics.json; then
          echo "No changes to commit"
        else
          git add clone_statistics.json
          git commit -m "Update clone statistics [skip ci]" || exit 0
          git push
        fi
